---
title: "Análise de viagens de bicicleta na ciclovia da Av. Faria Lima, São Paulo"
author: "Vitor Aguiar"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
```

```{r pkgs}
library(dplyr)
library(tidyr)
library(readr)
library(purrr)
library(ggplot2)
```

```{r data}
allfiles <- list.files("../DadosDaCiclovia", recursive = TRUE, 
                       pattern = "\\d{4}-\\d{2}-\\d{2}\\.csv$", 
                       full.names = TRUE)

ciclo_df <- 
  map_df(allfiles, ~read_csv(., col_types = "---T-----")) %>%
  separate(EVENT_TIME, c("date", "time"), sep = " ") %>%
  mutate(date = as.Date(date),
         weekday = weekdays(date))

day_counts <- 
  count(ciclo_df, date, weekday) %>%
  mutate(day_class = ifelse(weekday %in% c("Saturday", "Sunday"), weekday, "weekday"))
  
hour_averages <-
  ciclo_df %>%
  separate(time, c("h", "m", "s"), sep = ":", convert = TRUE) %>%
  mutate(day_class = ifelse(weekday %in% c("Saturday", "Sunday"), weekday, "weekday")) %>%
  count(date, h, day_class) %>%
  group_by(h, day_class) %>%
  summarise(average = mean(n))
```

```{r plot_timeseries, fig.width=8, fig.height=5}
ggplot(day_counts, aes(date, n)) +
  geom_line(size = .6, alpha = .5) +
  geom_point(aes(color = day_class), size = 1.6, alpha = .8) +
  geom_smooth(method = "loess", span = .4, se = FALSE, size = 2, color = "grey20") +
  scale_color_manual(name = NULL,
                     values = c("weekday" = "grey35",
                                "Saturday" = "orangered3",
                                "Sunday" = "royalblue"),
                     labels = c("weekday" = "dia de semana", 
                                "Saturday" = "sábado",
                                "Sunday" = "domingo")) +
  theme(legend.position = c(.1, .85),
        legend.margin = margin(6, 6, 6, 6)) +
  labs(x = " ", y = NULL,
       title = "Número de viagens de bicicleta por dia na ciclovia da Av. Faria Lima",
       caption = "Dados: https://github.com/LabProdam/DadosDaCiclovia")

#ggsave("../DadosDaCiclovia/plot_ciclovia.png", device = "png", height = 5, 
#       width = 8, units = "in", dpi = 200)
```

```{r plot_averages_per_hour, fig.width=8, fig.height=5}
ggplot(hour_averages, aes(h, average, color = factor(day_class))) +
  geom_point(alpha = .92, size = 3) +
  geom_line(alpha = .8, size = 2) +
  scale_x_continuous(breaks = 0:23) +
  scale_color_manual(name = NULL,
                     values = c("weekday" = "grey35",
                                "Saturday" = "orangered3",
                                "Sunday" = "royalblue"),
                     labels = c("weekday" = "dia de semana", 
                                "Saturday" = "sábado",
                                "Sunday" = "domingo")) +
  theme(legend.position = c(.1, .87),
        legend.margin = margin(6, 6, 6, 6)) +
  labs(title = "Média de viagens de bicicleta por hora do dia na ciclovia da Av. Faria Lima",
       subtitle = "(Junho 2015 - Junho 2017)",
       caption = "Dados: https://github.com/LabProdam/DadosDaCiclovia",
       x = "hora", y = "média")

#ggsave("../DadosDaCiclovia/plot_ciclovia_mediaHora.png", device = "png", height = 5, 
#       width = 8, units = "in", dpi = 300)
```